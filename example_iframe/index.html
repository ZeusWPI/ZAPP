<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>HTML 5 Boilerplate</title>
    <link rel="stylesheet" href="style.css" />

    <script
      type="module"
      src="https://zapp.zeus.gent/zapp-components/zapp-components.esm.js"
    ></script>
    <script
      nomodule
      src="https://zapp.zeus.gent/zapp-components/zapp-components.js"
    ></script>
    <link
      rel="stylesheet"
      href="https://zapp.zeus.gent/zapp-components/assets/global.css"
    />

    <script>

      let box = {x: 0, y: 0, height: 0, width: 0};
      let setsize = false;
      let w = 0;
      let h = 0;

      const outsideclickhandler = (ev) => {
        const path = ev.composedPath();
        console.log("click")
        const clickedInside =
          path.some((n) => n && n.id === 'zappbutton') ||
          path.some((n) => n && n.id === 'zappdropdown');
        if (!clickedInside) {
          console.log("outside")
          document.getElementById("zappdropdown").contentWindow.postMessage({type: "outsideclick"}, "*")
          document.getElementById("zappbutton").contentWindow.postMessage({type: "outsideclick"}, "*")
        }
      };
      window.addEventListener("click", outsideclickhandler);
      let opened = false;
      const GAP = 4;

      function position(){
        var vroot = document.getElementById("zappdropdown")
        const vrect = document.getElementById("zappbutton").getBoundingClientRect();
        console.log({w, h})

        const vw = window.innerWidth;
        const vh = window.innerHeight;

        let left = vrect.x;
        let topBelow = vrect.y + vrect.height + GAP;
        let top = topBelow;

        // Horizontal clamp
        if(left + w > vw - GAP) left = Math.max(GAP, vw - w - GAP);
        if(left < GAP) left = GAP;

        // Prefer below, fallback above if overflow
        if(top + h > vh - GAP){
          const topAbove = vrect.y - h - GAP;
          if(topAbove >= GAP){
            top = topAbove;
          }else{
            // Clamp inside viewport
            top = Math.max(GAP, Math.min(top, vh - h - GAP));
          }
        }

        vroot.style.left = left + "px";
        vroot.style.top = top + "px";
      }

      function openAnimation(){
        console.log("open animation")
        const root = document.getElementById("zappdropdown");
        const rect = document.getElementById("zappbutton").getBoundingClientRect();
        console.log({rect: root.getBoundingClientRect(), buttonbox: box})
        
        // Avoid duplicating listeners
        if(!root._repositionBound){
          const handler = () => position();
          window.addEventListener("resize", handler);
          window.addEventListener("scroll", handler, true);
          root._repositionBound = true;
        }

        position(rect);
      }

      window.onmessage = function(e){

        // box could have changed size
        box = document.getElementById("zappbutton").getBoundingClientRect();


        try{
          let msg = JSON.parse(e.data);
          if(msg.type === "buttonclick"){
            opened = !opened;
            console.log({opened})
            box = document.getElementById("zappbutton").getBoundingClientRect();
            // document.getElementById("zappdropdown").style.left = `${box.x}px`;
            // document.getElementById("zappdropdown").style.top = `calc(${box.y + box.height}px + 0.2rem)`;
            document.getElementById("zappdropdown").contentWindow.postMessage({type: 'rect', rect: box}, "*")

            document.getElementById("zappdropdown").style.visibility = opened ? "visible" : "hidden";
            if(opened) openAnimation();

          }else if(msg.type === "dropdown-box" && !setsize){
            setsize = true;
            w = msg.box.width;
            h = msg.box.height;
            document.getElementById("zappdropdown").style.width = `${msg.box.width}px`;
            document.getElementById("zappdropdown").style.height = `${msg.box.height + 7}px`;
            console.log("set dropdown iframe size");
          }else if(msg.type === "state"){
            opened = msg.state;
            document.getElementById("zappdropdown").style.display = opened ? "block" : "none";
            document.getElementById("zappbutton").contentWindow.postMessage(msg, "*")
          }
          else{
            alert("no supported msg type: " + msg.type)
          }
        }catch(err){
          console.error(err);
          alert("error");
        }
      }
    </script>
  </head>

  <body>
    <div class="topnav">
      <a class="active" href="#home">Home</a>
      <a href="#news">News</a>
      <a href="#contact">Contact</a>
      <a href="#about">About</a>

      <div style="height: 2.8em; aspect-ratio: 1 / 1">
        <zapp-v01 />
      </div>

      <iframe
        id="zappbutton"
        src="http://localhost:5173/button"
        style="height: 3.7em; aspect-ratio: 1 / 1; border: none; overflow: hidden; scrollbar-width: 0;"
      >
      </iframe>
    </div>

    <iframe
      id="zappdropdown"
      src="http://localhost:5173/dropdown"
      style="border-style: none; position: absolute; left: 0; top: 0; height: 100vh; width: 100vw; overflow: hidden; visibility: hidden;"
    />



    <p style="color: white;">kqsjmdlkfjqksljdflkmqjsdlmkfjqlksdmfjklqsdjfklqjdslkfjqlsdfjlqksdfjqdsjmfjmqlksdjflkqjsdflkjqsdfkqsjmdlkfjqksljdflkmqjsdlmkfjqlksdmfjklqsdjfklqjdslkfjqlsdfjlqksdfjqdsjmfjmqlksdjflkqjsdflkjqsdfkqsjmdlkfjqksljdflkmqjsdlmkfjqlksdmfjklqsdjfklqjdslkfjqlsdfjlqksdfjqdsjmfjmqlksdjflkqjsdflkjqsdfkqsjmdlkfjqksljdflkmqjsdlmkfjqlksdmfjklqsdjfklqjdslkfjqlsdfjlqksdfjqdsjmfjmqlksdjflkqjsdflkjqsdfkqsjmdlkfjqksljdflkmqjsdlmkfjqlksdmfjklqsdjfklqjdslkfjqlsdfjlqksdfjqdsjmfjmqlksdjflkqjsdflkjqsdfkqsjmdlkfjqksljdflkmqjsdlmkfjqlksdmfjklqsdjfklqjdslkfjqlsdfjlqksdfjqdsjmfjmqlksdjflkqjsdflkjqsdf
      kqsjmdlkfjqksljdflkmqjsdlmkfjqlksdmfjklqsdjfklqjdslkfjqlsdfjlqksdfjqdsjmfjmqlksdjflkqjsdflkjqsdfkqsjmdlkfjqksljdflkmqjsdlmkfjqlksdmfjklqsdjfklqjdslkfjqlsdfjlqksdfjqdsjmfjmqlksdjflkqjsdflkjqsdfkqsjmdlkfjqksljdflkmqjsdlmkfjqlksdmfjklqsdjfklqjdslkfjqlsdfjlqksdfjqdsjmfjmqlksdjflkqjsdflkjqsdfkqsjmdlkfjqksljdflkmqjsdlmkfjqlksdmfjklqsdjfklqjdslkfjqlsdfjlqksdfjqdsjmfjmqlksdjflkqjsdflkjqsdfkqsjmdlkfjqksljdflkmqjsdlmkfjqlksdmfjklqsdjfklqjdslkfjqlsdfjlqksdfjqdsjmfjmqlksdjflkqjsdflkjqsdf
      kqsjmdlkfjqksljdflkmqjsdlmkfjqlksdmfjklqsdjfklqjdslkfjqlsdfjlqksdfjqdsjmfjmqlksdjflkqjsdflkjqsdfkqsjmdlkfjqksljdflkmqjsdlmkfjqlksdmfjklqsdjfklqjdslkfjqlsdfjlqksdfjqdsjmfjmqlksdjflkqjsdflkjqsdfkqsjmdlkfjqksljdflkmqjsdlmkfjqlksdmfjklqsdjfklqjdslkfjqlsdfjlqksdfjqdsjmfjmqlksdjflkqjsdflkjqsdfkqsjmdlkfjqksljdflkmqjsdlmkfjqlksdmfjklqsdjfklqjdslkfjqlsdfjlqksdfjqdsjmfjmqlksdjflkqjsdflkjqsdfkqsjmdlkfjqksljdflkmqjsdlmkfjqlksdmfjklqsdjfklqjdslkfjqlsdfjlqksdfjqdsjmfjmqlksdjflkqjsdflkjqsdf
      kqsjmdlkfjqksljdflkmqjsdlmkfjqlksdmfjklqsdjfklqjdslkfjqlsdfjlqksdfjqdsjmfjmqlksdjflkqjsdflkjqsdfkqsjmdlkfjqksljdflkmqjsdlmkfjqlksdmfjklqsdjfklqjdslkfjqlsdfjlqksdfjqdsjmfjmqlksdjflkqjsdflkjqsdfkqsjmdlkfjqksljdflkmqjsdlmkfjqlksdmfjklqsdjfklqjdslkfjqlsdfjlqksdfjqdsjmfjmqlksdjflkqjsdflkjqsdfkqsjmdlkfjqksljdflkmqjsdlmkfjqlksdmfjklqsdjfklqjdslkfjqlsdfjlqksdfjqdsjmfjmqlksdjflkqjsdflkjqsdfkqsjmdlkfjqksljdflkmqjsdlmkfjqlksdmfjklqsdjfklqjdslkfjqlsdfjlqksdfjqdsjmfjmqlksdjflkqjsdflkjqsdf
      kqsjmdlkfjqksljdflkmqjsdlmkfjqlksdmfjklqsdjfklqjdslkfjqlsdfjlqksdfjqdsjmfjmqlksdjflkqjsdflkjqsdfkqsjmdlkfjqksljdflkmqjsdlmkfjqlksdmfjklqsdjfklqjdslkfjqlsdfjlqksdfjqdsjmfjmqlksdjflkqjsdflkjqsdfkqsjmdlkfjqksljdflkmqjsdlmkfjqlksdmfjklqsdjfklqjdslkfjqlsdfjlqksdfjqdsjmfjmqlksdjflkqjsdflkjqsdfkqsjmdlkfjqksljdflkmqjsdlmkfjqlksdmfjklqsdjfklqjdslkfjqlsdfjlqksdfjqdsjmfjmqlksdjflkqjsdflkjqsdfkqsjmdlkfjqksljdflkmqjsdlmkfjqlksdmfjklqsdjfklqjdslkfjqlsdfjlqksdfjqdsjmfjmqlksdjflkqjsdflkjqsdf
      kqsjmdlkfjqksljdflkmqjsdlmkfjqlksdmfjklqsdjfklqjdslkfjqlsdfjlqksdfjqdsjmfjmqlksdjflkqjsdflkjqsdfkqsjmdlkfjqksljdflkmqjsdlmkfjqlksdmfjklqsdjfklqjdslkfjqlsdfjlqksdfjqdsjmfjmqlksdjflkqjsdflkjqsdfkqsjmdlkfjqksljdflkmqjsdlmkfjqlksdmfjklqsdjfklqjdslkfjqlsdfjlqksdfjqdsjmfjmqlksdjflkqjsdflkjqsdfkqsjmdlkfjqksljdflkmqjsdlmkfjqlksdmfjklqsdjfklqjdslkfjqlsdfjlqksdfjqdsjmfjmqlksdjflkqjsdflkjqsdfkqsjmdlkfjqksljdflkmqjsdlmkfjqlksdmfjklqsdjfklqjdslkfjqlsdfjlqksdfjqdsjmfjmqlksdjflkqjsdflkjqsdf
    </p>
  </body>
</html>
