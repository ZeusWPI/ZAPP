<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>HTML 5 Boilerplate</title>
    <link rel="stylesheet" href="style.css" />

    <script
      type="module"
      src="https://zapp.zeus.gent/zapp-components/zapp-components.esm.js"
    ></script>
    <script
      nomodule
      src="https://zapp.zeus.gent/zapp-components/zapp-components.js"
    ></script>
    <link
      rel="stylesheet"
      href="https://zapp.zeus.gent/zapp-components/assets/global.css"
    />

    <script>
      window.onmessage = function(e){

        const outsideclickhandler = (ev) => {
          const path = ev.composedPath();
          console.log("click")
          const clickedInside =
            path.some((n) => n && n.id === 'zappbutton') ||
            path.some((n) => n && n.id === 'zappdropdown');
          if (!clickedInside) {
            console.log("outside")
            document.getElementById("zappdropdown").contentWindow.postMessage({type: "outsideclick"}, "http://localhost:5173")
          }
        };
        window.addEventListener("click", outsideclickhandler)

        window.document.addEventListener('myCustomEvent', handleEvent, false)
        function handleEvent(e) {
          console.log(e.detail) // outputs: {foo: 'bar'}
        }

        let setsize = false;
        let opened = false;

        try{
          let msg = JSON.parse(e.data);
          if(msg.type === "buttonclick"){
            opened = !opened;
            const box = document.getElementById("zappbutton").getBoundingClientRect();
            document.getElementById("zappdropdown").style.left = `${box.x}px`;
            document.getElementById("zappdropdown").style.top = `calc(${box.y + box.height}px + 0.2rem)`;
            document.getElementById("zappdropdown").style.display = opened ? "block" : "none";
            document.getElementById("zappdropdown").contentWindow.postMessage({type: 'rect', rect: box}, "http://localhost:5173")
          }else if(msg.type === "dropdown-box" && !setsize){
            setsize = true;
            document.getElementById("zappdropdown").style.width = `${msg.box.width}px`;
            document.getElementById("zappdropdown").style.height = `${msg.box.height + 7}px`;
            console.log("set dropdown iframe size")
          }
          else{
            alert("no supported msg type: " + msg.type)
          }
        }catch(err){
          console.error(err);
          alert("error");
        }
      }
    </script>
  </head>

  <body>
    <div class="topnav">
      <a class="active" href="#home">Home</a>
      <a href="#news">News</a>
      <a href="#contact">Contact</a>
      <a href="#about">About</a>

      <div style="height: 2.8em; aspect-ratio: 1 / 1">
        <zapp-v01 />
      </div>

      <iframe
        id="zappbutton"
        src="http://localhost:5173/button"
        style="height: 2.8em; aspect-ratio: 1 / 1; border: none"
      >
      </iframe>
    </div>

    <iframe
      id="zappdropdown"
      src="http://localhost:5173/dropdown"
      style="border-style: none; position: absolute; left: 0; top: 0; height: 100vh; width: 100vw; overflow: hidden; display: none;"
    />
  </body>
</html>
